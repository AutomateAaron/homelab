services:
  caddy:
    build:
      context: .
      dockerfile_inline: |
        FROM caddy:2-builder AS builder

        RUN xcaddy build \
            --with github.com/lucaslorentz/caddy-docker-proxy/v2 \
            --with github.com/caddy-dns/cloudflare

        FROM caddy:2

        COPY --from=builder /usr/bin/caddy /usr/bin/caddy

        CMD ["caddy", "docker-proxy"]
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - caddy_data:/data
    networks:
      - caddy
    restart: unless-stopped
    environment:
    - CLOUDFLARE_API_TOKEN=${CADDY_CLOUDFLARE_API_TOKEN}
    labels:
      caddy.email: aaron@automateaaron.com

  whoami:
    image: traefik/whoami
    networks:
      - caddy
    labels:
      caddy: "whoami.automateaaron.com"
      caddy.reverse_proxy: "{{upstreams 80}}"
      caddy.tls.dns: "cloudflare ${CADDY_CLOUDFLARE_API_TOKEN}"

  cloudflared:
    image: cloudflare/cloudflared
    restart: ${UNIVERSAL_RESTART_POLICY:-unless-stopped}
    command: tunnel run
    networks:
      - caddy
    environment:
      - TUNNEL_TOKEN=${CLOUDFLARE_TUNNEL_TOKEN}

networks:
  caddy:
    driver: bridge

volumes:
  caddy_data:
